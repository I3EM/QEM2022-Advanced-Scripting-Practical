<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Extracting the Pseudospectrum - QEM Pratical: Advanced Script Programming for Image Processing in Digital Micrograph</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../mdbook-admonish.css">
        <link rel="stylesheet" href="../mermaid.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../0-introduction/introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../0-introduction/using-this-document.html">How to Use this Document</a></li><li class="chapter-item expanded affix "><a href="../0-introduction/mystery_processing.html">Overview of the Mystery Processing</a></li><li class="chapter-item expanded "><a href="../1-extracting-pseudospectrum/recap.html"><strong aria-hidden="true">1.</strong> Reverting the Transfer Function</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../1-extracting-pseudospectrum/pseudospectrum.html" class="active"><strong aria-hidden="true">1.1.</strong> Extracting the Pseudospectrum</a></li><li class="chapter-item expanded "><a href="../2-averaging-maximas/maxima.html"><strong aria-hidden="true">1.2.</strong> Averaging Maxima Positions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2-averaging-maximas/peak_finding.html"><strong aria-hidden="true">1.2.1.</strong> Suggested Approach</a></li><li class="chapter-item expanded "><a href="../2-averaging-maximas/solution_part1b.html"><strong aria-hidden="true">1.2.2.</strong> Proposed Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../3-reverting-transfert-function/mtf.html"><strong aria-hidden="true">1.3.</strong> Performing the Inversion</a></li></ol></li><li class="chapter-item expanded "><a href="../4-removing-polynomials/part_2.html"><strong aria-hidden="true">2.</strong> Removing the Distortion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../4-removing-polynomials/lls.html"><strong aria-hidden="true">2.1.</strong> Suggested Approach</a></li><li class="chapter-item expanded "><a href="../4-removing-polynomials/solution_part2.html"><strong aria-hidden="true">2.2.</strong> Proposed Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../5-installing-scripts/part_3.html"><strong aria-hidden="true">3.</strong> Reconstructing the Image</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../6-appendices/references.html">To Go Further</a></li><li class="chapter-item expanded affix "><a href="../6-appendices/mystery_processing_complete.html">Mystery Processing: Complete Script</a></li><li class="chapter-item expanded affix "><a href="../6-appendices/proposed_solution_complete.html">Proposed Solution: Complete Script</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">QEM Pratical: Advanced Script Programming for Image Processing in Digital Micrograph</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="extracting-the-pseudospectrum"><a class="header" href="#extracting-the-pseudospectrum">Extracting the Pseudospectrum</a></h1>
<pre class="mermaid">
graph TD
    classDef important fill:firebrick
    classDef starts fill:indianred
    classDef focus fill:forestgreen
    classDef done fill:dimgrey
    classDef obj fill:chocolate
    subgraph Mystery Processing
        Start([Start]):::starts--&gt;mystery_image[/Mystery Image/]:::important
        mystery_image--&gt;swap[Mystery Swap]
        swap--&gt;polynomial[Addition of Random Polynomial Background]
        polynomial--&gt;mtf[Application of a Transfert Function]
        mtf--&gt;tag[Attach Pseudospectrum as Metadata]
        tag--&gt;coded_image[/Encoded Image/]:::important
        coded_image--&gt;End([End]):::starts
        Start--&gt;rand_vec[Random Numbers Generation]
        rand_vec--&gt;maxs[/Random Numbers/]
        maxs--&gt;mean[Averaging]
        mean--&gt;mtf
        maxs--&gt;gspec[Generate a Pseudospectrum with Input Maximums]
        gspec--&gt;pspec[/Pseudospectrum/]
        pspec--&gt;tag
    end
    class tag focus
    class pspec obj
</pre>
<p>We have just seen that before even starting to process our encoded image,
we had to extract another &quot;Pseudospectrum&quot; image from its metadata. To know
how we should proceed, let's take a look at the code that stored that
Pseudospectrum:</p>
<pre><code class="language-java">add_image_tag(output, &quot;Pseudospectrum&quot;, pseudo_spectrum)
</code></pre>
<p>The <code>add_image_tag</code> function is defined as follows:</p>
<pre><code class="language-java">// Stores the `img_tag` 1D image as a tag of the `img` image under the `tag` path,
// alongside with its size.
void add_image_tag(Image img, String tag, Image img_tag) {
	TagGroup tags = imageGetTagGroup(img)

	tagGroupSetTagAsArray(tags, tag, img_tag)
	tagGroupSetTagAsNumber(tags, tag + &quot; Size&quot;, imageGetDimensionSize(img_tag, 0))
}
</code></pre>
<p>We can see here that the <code>img</code> metadata is manipulated through a <code>TagGroup</code>
that we can obtain by calling <code>imageGetTagGroup</code> on the image. Then,
the actual metadata may be set by calling the corresponding <code>tagGroupSetTagAs*</code>
on the <code>TagGroup</code> (namely <code>tagGroupSetTagAsNumber</code> and <code>tagGroupSetTagAsImage</code>
in our case).</p>
<div id="admonition-imagegetdimensionsizeimg-n" class="admonition info">
<div class="admonition-title">
<p><code>imageGetDimensionSize(img, n)</code></p>
</div>
<div>
<p>Returns the size of the <code>n</code>-th dimension of the image <code>img</code>.</p>
</div>
</div>
<h2 id="getting-back-metadata"><a class="header" href="#getting-back-metadata">Getting Back Metadata</a></h2>
<p>If we want to get that metadata back, we will need the <code>tagGroupGetTagAs*</code> family
of functions, specifically <code>tagGroupGetTagAsNumber</code> and <code>tagGroupGetTagAsImage</code>.
<code>tagGroupGetTagAsNumber</code>, for example, is used as such:</p>
<pre><code class="language-java">Number n
tagGroupGetTagAsNumber(tags, &quot;Tag Path&quot;, n)
result(&quot;Read number &quot; + n + &quot;\n&quot;)
</code></pre>
<p>As those functions may fail (the tag path may not exist, the data type
may be incorrect...), they signal succes by returning <code>1</code> and failure by
returning <code>0</code>. This behaviour may be used as such:</p>
<pre><code class="language-java">Number n
if (tagGroupGetTagAsNumber(tags, &quot;Tag Path&quot;, n)) {
    result(&quot;Succefully read number &quot; + n + &quot;\n&quot;)
} else {
    result(&quot;The tag 'Tag Path' does not exist on this image!\n&quot;)
}
</code></pre>
<p>In the case of <code>tagGroupGetTagAsArray</code>, the story become a little
more complicated. <code>tagGroupGetTagAsArray</code> will only write data to
an already allocated image. Therefore, one need to know in advance
the size of the image, so they can allocate the right amount. That is
why a common pattern is to store the image size in an other number
tag. When the image <code>size</code> is known, <code>tagGroupGetTagAsArray</code> is
used as such:</p>
<pre><code class="language-java">Image img_tag := RealImage(&quot;&quot;, 8, size)
tagGroupGetTagAsArray(tags, &quot;Tag Path&quot;, img_tag)
</code></pre>
<h2 id="getting-back-the-pseudospectrum"><a class="header" href="#getting-back-the-pseudospectrum">Getting Back the Pseudospectrum</a></h2>
<p>Putting thoses functions together, we can easily build an extraction
function for us to use:</p>
<pre><code class="language-java">Image get_image_tag(Image img, String tag) {
	TagGroup tags = imageGetTagGroup(img)

	Number size
	tagGroupGetTagAsNumber(tags, tag + &quot; Size&quot;, size)

	Image img_tag := realImage(&quot;&quot;, 8, size)
	tagGroupGetTagAsArray(tags, tag, img_tag)

	return img_tag
}
</code></pre>
<p>The complete script should then look like this:</p>
<pre><code class="language-java">Image get_image_tag(Image img, String tag) {
	TagGroup tags = imageGetTagGroup(img)

	Number size
	tagGroupGetTagAsNumber(tags, tag + &quot; Size&quot;, size)

	Image img_tag := realImage(&quot;&quot;, 8, size)
	tagGroupGetTagAsArray(tags, tag, img_tag)

	return img_tag
}


Image src := getFrontImage()

Image pseudo_spectrum := get_image_tag(src, &quot;Pseudospectrum&quot;)

showImage(pseudo_spectrum)
</code></pre>
<!-- ~~~admonish example title="Mystery Processing Recap" collapsible=true
```java
Image src := getFrontImage()

Image mystery_swapped := mystery_swap(src)

Image with_polynomial := add_random_polynomial(mystery_swapped)

Image maximum_positions := round(random_image_with_min_dist(4, 10, 990, 50))
Number s = round( mean(maximum_positions) / 8 )
Image pseudo_spectrum := pseudospectrum_with_maximums_at(1000, maximum_positions)

Image output := apply_inverse_gaussian_mtf(with_polynomial, s)

add_image_tag(output, "Pseudospectrum", pseudo_spectrum)

showImage(output)
```
~~~ -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../1-extracting-pseudospectrum/recap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../2-averaging-maximas/maxima.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../1-extracting-pseudospectrum/recap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../2-averaging-maximas/maxima.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>


    </body>
</html>
