<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reconstructing the Image - QEM Practical: Advanced Script Programming for Image Processing in Digital Micrograph</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../mdbook-admonish.css">
        <link rel="stylesheet" href="../mermaid.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../0-introduction/introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../0-introduction/using-this-document.html">How to Use this Document</a></li><li class="chapter-item expanded affix "><a href="../0-introduction/pick_image.html">Pick an Image</a></li><li class="chapter-item expanded affix "><a href="../0-introduction/mystery_processing.html">Overview of the Mystery Processing</a></li><li class="chapter-item expanded "><a href="../1-extracting-pseudospectrum/recap.html"><strong aria-hidden="true">1.</strong> Reverting the Transfer Function</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../1-extracting-pseudospectrum/pseudospectrum.html"><strong aria-hidden="true">1.1.</strong> Extracting the Pseudospectrum</a></li><li class="chapter-item expanded "><a href="../2-averaging-maximas/maxima.html"><strong aria-hidden="true">1.2.</strong> Averaging Maxima Positions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2-averaging-maximas/peak_finding.html"><strong aria-hidden="true">1.2.1.</strong> Suggested Approach</a></li><li class="chapter-item expanded "><a href="../2-averaging-maximas/solution_part1b.html"><strong aria-hidden="true">1.2.2.</strong> Proposed Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../3-reverting-transfer-function/mtf.html"><strong aria-hidden="true">1.3.</strong> Performing the Inversion</a></li></ol></li><li class="chapter-item expanded "><a href="../4-removing-polynomials/part_2.html"><strong aria-hidden="true">2.</strong> Removing the Distortion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../4-removing-polynomials/lls.html"><strong aria-hidden="true">2.1.</strong> Suggested Approach</a></li><li class="chapter-item expanded "><a href="../4-removing-polynomials/solution_part2.html"><strong aria-hidden="true">2.2.</strong> Proposed Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../5-installing-scripts/part_3.html" class="active"><strong aria-hidden="true">3.</strong> Reconstructing the Image</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../6-appendices/references.html">To Go Further</a></li><li class="chapter-item expanded affix "><a href="../6-appendices/mystery_processing_complete.html">Mystery Processing: Complete Script</a></li><li class="chapter-item expanded affix "><a href="../6-appendices/proposed_solution_complete.html">Proposed Solution: Complete Script</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">QEM Practical: Advanced Script Programming for Image Processing in Digital Micrograph</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reconstructing-the-image"><a class="header" href="#reconstructing-the-image">Reconstructing the Image</a></h1>
<div id="admonition-info" class="admonition info">
<div class="admonition-title">
<p>Info</p>
</div>
<div>
<p>For this section, we will need the <a href="../dmscripts/mystery_unswap.s" download>following library file</a>.</p>
</div>
</div>
<pre class="mermaid">
graph TD
    classDef important fill:firebrick
    classDef starts fill:indianred
    classDef focus fill:forestgreen
    classDef done fill:dimgrey
    classDef obj fill:chocolate
    subgraph Mystery Processing
        Start([Start]):::starts--&gt;mystery_image[/Mystery Image/]:::important
        mystery_image--&gt;swap[Mystery Swap]
        swap--&gt;polynomial[Addition of Random Polynomial Background]
        polynomial--&gt;mtf[Application of a Transfert Function]
        mtf--&gt;tag[Attach Pseudospectrum as Metadata]
        tag--&gt;coded_image[/Encoded Image/]:::important
        coded_image--&gt;End([End]):::starts
        Start--&gt;rand_vec[Random Numbers Generation]
        rand_vec--&gt;maxs[/Random Numbers/]
        maxs--&gt;mean[Averaging]
        mean--&gt;mtf
        maxs--&gt;gspec[Generate a Pseudospectrum with Input Maximums]
        gspec--&gt;pspec[/Pseudospectrum/]
        pspec--&gt;tag
    end
    class swap focus
    class polynomial,mtf,tag,pspec,gspec,maxs,rand,mean,rand_vec done
</pre>
<p>In this section, we will perform the last step of image reconstruction, with the
help of an external function that we will install.</p>
<p>The goal this time is not to build the function ourselves, but rather to learn how
to install a script persistently, for other scripts to use. This is necessary in order
to be able to reuse software.</p>
<div id="admonition-tip" class="admonition tip">
<div class="admonition-title">
<p>Tip</p>
</div>
<div>
<p>You should try to split your software in as many units of logic as possible. You
may then put those separate bits of logic in different (properly named) functions.
It is not an easy task, and it may require taking a step back, but it is worth it.</p>
<p>This approach has several benefits:</p>
<ol>
<li>It makes us write code that is easier to read, by separating your main task in
several subtasks (that may be then separated in subsubtasks and so on).</li>
<li>It makes us write code that may be reusable, so we or other people may
build upon it instead of systematically reinventing the wheel.</li>
<li>It also means that we have only one place to modify if we want to improve
a function that is used by several scripts</li>
</ol>
<!--
Compare for example:
```java
Image src := getfrontimage()

Image fft := realfft(src) * exp(-4 * icol**2 - 4 * irow**2)
``` -->
</div>
</div>
<h2 id="installing-and-uninstalling-a-script"><a class="header" href="#installing-and-uninstalling-a-script">Installing and Uninstalling a Script</a></h2>
<p>In order to integrate our scripts in Digital Micrograph,
we have the option of installing them persistently.</p>
<p>Digital Micrograph gives us two option:</p>
<ol>
<li>
<p>We may install our script as a menu item, which will allow us to
run our script each time we click on the item. Using this, we will
have quick access to our processings.</p>
</li>
<li>
<p>We may install our script as a library, which helps in making our functions
available to other scripts. The script will be automatically executed at
start-up, and every global state and function will be kept in memory until
shutdown (or explicit removal).</p>
<p>This mode may also be used for arbitrary code execution at start-up, for example
to automatically setup a connection with our microscope, to print some instrument
state in the <code>Output</code> window, to open the last closed image...</p>
</li>
</ol>
<details id="admonition-installing-a-script-as-a-library" class="admonition tip">
<summary class="admonition-title">
<p>Installing a script as a library</p>
</summary>
<div>
<ol>
<li>Make sure your script is open in Digital Micrograph.</li>
<li>Click on your script, to make sure it is selected.</li>
<li>Go to <code>File &gt; Install Script...</code>.</li>
<li>Click on the <code>Library</code> tab.</li>
<li><em>(Optional)</em> Rename your library on the text field if need be.</li>
<li>Select either <code>Install for the current user only</code> or <code>Install for all users</code>,
depending on your needs.</li>
<li>Click <code>Ok</code>.</li>
</ol>
<video controls>
    <source src="install_library.mp4" type="video/mp4">
    <track label="English" kind="subtitles" srclang="en" src="install_library.vtt" default>
<pre><code>Sorry, your browser doesn't support embedded videos.
</code></pre>
</video>
</div>
</details>
<details id="admonition-installing-a-script-as-a-menu-item" class="admonition tip">
<summary class="admonition-title">
<p>Installing a script as a menu item</p>
</summary>
<div>
<ol>
<li>Make sure your script is open in Digital Micrograph.</li>
<li>Click on your script, to make sure it is selected.</li>
<li>Go to <code>File &gt; Install Script...</code>.</li>
<li>Rename your command on the <code>Name of command?</code> text field.</li>
<li>Name the menu to put your command in the <code>Which menu?</code> text field.</li>
<li><em>(Optional)</em> Name a submenu to put your command in the <code>Optional submenu?</code> text field.</li>
<li>Select either <code>Install for the current user only</code> or <code>Install for all users</code>,
depending on your needs.</li>
<li>Click <code>Ok</code>.</li>
</ol>
<video controls>
    <source src="install_menu.mp4" type="video/mp4">
    <track label="English" kind="subtitles" srclang="en" src="install_menu.vtt" default>
<pre><code>Sorry, your browser doesn't support embedded videos.
</code></pre>
</video>
</div>
</details>
<details id="admonition-removing-a-script" class="admonition tip">
<summary class="admonition-title">
<p>Removing a script</p>
</summary>
<div>
<ol>
<li>Go to <code>File &gt; Remove Script...</code>.</li>
<li>If your script was installed for all users, click on the <code>All Users</code> tab,
otherwise stay here.</li>
<li>Select your script on the list.</li>
<li>Click <code>Remove</code>.</li>
</ol>
<video controls>
    <source src="removing_a_script.mp4" type="video/mp4">
    <track label="English" kind="subtitles" srclang="en" src="removing_a_script.vtt" default>
<pre><code>Sorry, your browser doesn't support embedded videos.
</code></pre>
</video>
</div>
</details>
<h2 id="installing-the-mystery-unswap"><a class="header" href="#installing-the-mystery-unswap">Installing the Mystery Unswap</a></h2>
<p>If you did not already, download the <a href="../dmscripts/mystery_unswap.s" download>library file</a>.
Then install it <em>as a library</em>, following the explanations from the previous section.</p>
<p>You may then use it with the following line:</p>
<pre><code class="language-java">Image out := mystery_unswap(step2)
</code></pre>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
</div>
<div>
<p>Please do not forget to uninstall the <code>mystery_unswap</code> script be fore leaving,
so that your classmates may reinstall it without trouble.</p>
</div>
</div>
<h2 id="final-proposed-implementation"><a class="header" href="#final-proposed-implementation">Final Proposed Implementation</a></h2>
<div id="admonition-warning-1" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
</div>
<div>
<p>A solution to the problem is given below.
Before consulting it, we encourage you to make your own tries.</p>
</div>
</div>
<details id="admonition-solution" class="admonition example">
<summary class="admonition-title">
<p>Solution</p>
</summary>
<div>
<pre><code class="language-java">Image get_image_tag(Image img, String tag) {
	TagGroup tags = imageGetTagGroup(img)

	Number size
	tagGroupGetTagAsNumber(tags, tag + &quot; Size&quot;, size)

	Image img_tag := realImage(&quot;&quot;, 8, size)
	tagGroupGetTagAsArray(tags, tag, img_tag)

	return img_tag
}

Number mean_maximum_positions(Image img) {
	Number size = imageGetDimensionSize(img, 0)

	Number mean = 0
	Number maximums_number = 0

	for (Number i = 1 ; i &lt; size - 1 ; ++i) {
		if (getPixel(img, i - 1, 0) &lt;= getPixel(img, i, 0) &amp;&amp; \
			getPixel(img, i + 1, 0) &lt;= getPixel(img, i, 0)) {
			++maximums_number
			mean += (i - mean)/maximums_number
			++i
		}
	}

	return mean
}

Image deconvolve_inverse_gaussian_mtf(Image img, Number s) {
	ComplexImage fft := realFft(img)

	Number x_size = imageGetDimensionSize(fft, 0)
	Number y_size = imageGetDimensionSize(fft, 1)

	Number x_0 = ceil(x_size / 2)
	Number y_0 = ceil(y_size / 2)

	fft *= exp( \
		- ((icol - x_0) * s/16 / 2 / x_size)**2 \
		- ((irow - y_0) * s/16 / 2 / y_size)**2 \
	)

	return realIfft(fft)
}

Image remove_polynomial_background(Image src) {
	Number x_size = imageGetDimensionSize(src, 0)
	Number y_size = imageGetDimensionSize(src, 1)

	Image xxy := realImage(&quot;&quot;, 8, x_size, y_size)
	xxy = icol * icol * irow / x_size / x_size / y_size
	Image  yy := realImage(&quot;&quot;, 8, x_size, y_size)
	yy  = irow * irow / y_size / y_size
	Image yyy := realImage(&quot;&quot;, 8, x_size, y_size)
	yyy = irow * irow * irow / y_size / y_size / y_size
	

	Image A := realImage(&quot;&quot;, 8, 3, 3)
	A[0, 0] = dotProduct(xxy, xxy)
	A[1, 0] = dotProduct(xxy,  yy)
	A[2, 0] = dotProduct(xxy, yyy)
	
	A[0, 1] = dotProduct( yy, xxy)
	A[1, 1] = dotProduct( yy,  yy)
	A[2, 1] = dotProduct( yy, yyy)
	
	A[0, 2] = dotProduct(yyy, xxy)
	A[1, 2] = dotProduct(yyy,  yy)
	A[2, 2] = dotProduct(yyy, yyy)

	Image b := realImage(&quot;&quot;, 8, 3, 1)
	b[0, 0] = dotProduct(xxy, src)
	b[1, 0] = dotProduct( yy, src)
	b[2, 0] = dotProduct(yyy, src)

	Image solution := svDecomposition(A, b)
	
	Image result := realImage(&quot;&quot;, 8, x_size, y_size)
	result = src - (\
		round(getPixel(solution, 0, 0)) * xxy + \
		round(getPixel(solution, 1, 0)) *  yy + \
		round(getPixel(solution, 2, 0)) * yyy   \
	)

	return result
}


Image src := getFrontImage()

Image pseudo_spectrum := get_image_tag(src, &quot;Pseudospectrum&quot;)

Number mean = mean_maximum_positions(pseudo_spectrum)
Number s = round( mean / 8 )

Image step1 := deconvolve_inverse_gaussian_mtf(src, s)

Image step2 := remove_polynomial_background(step1)

Image out := mystery_unswap(step2)

Image normalized := min(255, max(0, round(out)))
showImage(normalized)
</code></pre>
</div>
</details>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../4-removing-polynomials/solution_part2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../6-appendices/references.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../4-removing-polynomials/solution_part2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../6-appendices/references.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>


    </body>
</html>
